<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loomerly Pattern Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap');

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
        }

        /* Estilos do Canvas */
        .pattern-workspace {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 25px 25px;
            scroll-behavior: smooth;
        }

        /* O Nó */
        .knot-container {
            width: 50px;
            height: 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .knot-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 3px solid #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
        }

        .knot-circle:hover {
            transform: scale(1.15);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        /* Linhas que representam os fios */
        .string-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .row-group {
            display: flex;
            justify-content: center;
            margin-top: -12px;
        }

        .row-stagger {
            margin-left: 50px;
        }

        /* Sidebar UI */
        .control-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .color-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-dot.selected {
            border-color: #ec4899;
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.4);
        }

        .knot-icon {
            width: 18px;
            height: 18px;
            stroke: white;
            stroke-width: 4;
            fill: none;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row">

    <!-- Sidebar de Controlos -->
    <aside class="w-full md:w-80 border-r border-slate-200 bg-white flex flex-col shadow-2xl z-50">
        <div class="p-6">
            <div class="flex items-center gap-2 mb-2">
                <div class="bg-pink-500 p-2 rounded-lg text-white">
                    <i class="fas fa-bezier-curve"></i>
                </div>
                <h1 class="text-xl font-extrabold text-slate-800">Loomerly<span class="text-pink-500">Studio</span></h1>
            </div>
            <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Normal Pattern Designer</p>
        </div>

        <div class="flex-1 overflow-y-auto px-6 space-y-8 pb-8">
            <!-- Configurações -->
            <section>
                <h3 class="text-xs font-bold text-slate-500 mb-4 uppercase">Configuração</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="font-medium text-slate-600">Número de Fios</span>
                            <span id="strCountText" class="text-pink-600 font-bold">8</span>
                        </div>
                        <input type="range" id="strRange" min="4" max="16" step="2" value="8" class="w-full h-2 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-pink-500">
                    </div>
                    <button id="addRow" class="w-full py-3 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i> Adicionar Linha
                    </button>
                </div>
            </section>

            <!-- Paleta de Fios -->
            <section>
                <h3 class="text-xs font-bold text-slate-500 mb-4 uppercase">Cores dos Fios</h3>
                <div id="stringPalette" class="grid grid-cols-4 gap-3 mb-4">
                    <!-- Gerado por JS -->
                </div>
                <div class="p-3 bg-slate-50 rounded-xl">
                    <label class="block text-[10px] font-bold text-slate-400 mb-2 uppercase">Mudar Cor Selecionada</label>
                    <input type="color" id="picker" class="w-full h-10 border-none bg-transparent cursor-pointer">
                </div>
            </section>

            <!-- Legenda -->
            <section class="bg-indigo-50 p-4 rounded-xl">
                <h4 class="text-[10px] font-bold text-indigo-400 mb-2 uppercase">Como Desenhar</h4>
                <ul class="text-[11px] text-indigo-700 space-y-2">
                    <li><i class="fas fa-mouse-pointer mr-1"></i> <strong>Clique</strong> no nó para alternar tipo.</li>
                    <li><i class="fas fa-tint mr-1"></i> As cores fluem automaticamente conforme os nós que cria.</li>
                </ul>
            </section>
        </div>

        <div class="p-6 border-t border-slate-100">
            <button id="exportBtn" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition flex items-center justify-center gap-2">
                <i class="fas fa-download"></i> Exportar Gráfico
            </button>
        </div>
    </aside>

    <!-- Workspace Principal -->
    <main class="flex-1 overflow-auto pattern-workspace flex flex-col items-center py-16">
        <!-- Indicadores de Cor no Topo -->
        <div id="threadStarts" class="flex gap-[38px] mb-8"></div>
        
        <!-- A Grelha de Nós -->
        <div id="patternGrid" class="flex flex-col"></div>
    </main>

    <script>
        // --- MOTOR DE SIMULAÇÃO ---
        const KNOT_TYPES = ['F', 'B', 'FB', 'BF'];
        const ICONS = {
            'F': 'M7 7l10 10m0-10v10h-10',    // Forward
            'B': 'M17 7L7 17M7 7v10h10',      // Backward
            'FB': 'M7 7h10v10M17 7L7 17',     // Forward-Backward
            'BF': 'M17 7H7v10M7 7l10 10'      // Backward-Forward
        };

        // Estado Inicial
        let numStrings = 8;
        let threadColors = ['#F87171', '#F87171', '#60A5FA', '#60A5FA', '#34D399', '#34D399', '#FBBF24', '#FBBF24'];
        let rows = [
            { knots: ['F', 'F', 'F', 'F'] },
            { knots: ['B', 'B', 'B'] },
            { knots: ['F', 'F', 'F', 'F'] },
            { knots: ['B', 'B', 'B'] },
            { knots: ['F', 'F', 'F', 'F'] },
            { knots: ['B', 'B', 'B'] }
        ];
        let activeThreadIdx = 0;

        // Cache de elementos
        const gridEl = document.getElementById('patternGrid');
        const startsEl = document.getElementById('threadStarts');
        const paletteEl = document.getElementById('stringPalette');
        const strRange = document.getElementById('strRange');
        const strCountText = document.getElementById('strCountText');

        function init() {
            renderPalette();
            renderApp();

            // Event Listeners
            strRange.oninput = (e) => {
                numStrings = parseInt(e.target.value);
                strCountText.textContent = numStrings;
                
                // Ajustar cores se necessário
                while(threadColors.length < numStrings) threadColors.push('#cbd5e1');
                threadColors = threadColors.slice(0, numStrings);
                
                // Resetar linhas para caber nova largura
                rows.forEach((r, i) => {
                    const isStaggered = i % 2 !== 0;
                    const count = isStaggered ? (numStrings/2 - 1) : (numStrings/2);
                    r.knots = Array(count).fill('F');
                });
                
                renderPalette();
                renderApp();
            };

            document.getElementById('picker').oninput = (e) => {
                threadColors[activeThreadIdx] = e.target.value;
                renderPalette();
                renderApp();
            };

            document.getElementById('addRow').onclick = () => {
                const isStaggered = rows.length % 2 !== 0;
                const count = isStaggered ? (numStrings/2 - 1) : (numStrings/2);
                rows.push({ knots: Array(count).fill('F') });
                renderApp();
            };

            document.getElementById('exportBtn').onclick = () => {
                window.print();
            };
        }

        function renderPalette() {
            paletteEl.innerHTML = '';
            threadColors.forEach((color, i) => {
                const dot = document.createElement('div');
                dot.className = `color-dot ${i === activeThreadIdx ? 'selected' : ''}`;
                dot.style.backgroundColor = color;
                dot.onclick = () => {
                    activeThreadIdx = i;
                    document.getElementById('picker').value = color;
                    renderPalette();
                };
                paletteEl.appendChild(dot);
            });
        }

        function renderApp() {
            gridEl.innerHTML = '';
            startsEl.innerHTML = '';

            // Desenhar indicadores superiores
            threadColors.forEach(c => {
                const dot = document.createElement('div');
                dot.className = "w-3 h-3 rounded-full border border-slate-200 shadow-sm";
                dot.style.backgroundColor = c;
                startsEl.appendChild(dot);
            });

            // SIMULAÇÃO DO FLUXO DAS CORES
            let stringState = [...threadColors];

            rows.forEach((row, rowIndex) => {
                const isStaggered = rowIndex % 2 !== 0;
                const rowDiv = document.createElement('div');
                rowDiv.className = `row-group ${isStaggered ? 'row-stagger' : ''}`;

                let nextState = [...stringState];

                row.knots.forEach((type, kIdx) => {
                    // Descobrir quais fios entram neste nó
                    const leftIdx = isStaggered ? (kIdx * 2) + 1 : (kIdx * 2);
                    const rightIdx = leftIdx + 1;

                    const colorL = stringState[leftIdx];
                    const colorR = stringState[rightIdx];

                    // Lógica de Nó (Cor visível e troca de posição)
                    let knotColor;
                    if (type === 'F') { 
                        knotColor = colorL; 
                        nextState[leftIdx] = colorR; nextState[rightIdx] = colorL;
                    } else if (type === 'B') { 
                        knotColor = colorR; 
                        nextState[leftIdx] = colorR; nextState[rightIdx] = colorL;
                    } else if (type === 'FB') { 
                        knotColor = colorL; 
                        nextState[leftIdx] = colorL; nextState[rightIdx] = colorR;
                    } else if (type === 'BF') { 
                        knotColor = colorR; 
                        nextState[leftIdx] = colorL; nextState[rightIdx] = colorR;
                    }

                    // Elemento Visual
                    const container = document.createElement('div');
                    container.className = 'knot-container';
                    
                    // SVG para as cordas que entram no nó
                    const svg = `
                        <svg class="string-svg" viewBox="0 0 50 50">
                            <!-- Corda Esquerda -->
                            <path d="M ${isStaggered ? -25 : 25} -25 L 25 25" stroke="${colorL}" stroke-width="5" fill="none" stroke-linecap="round" />
                            <!-- Corda Direita -->
                            <path d="M ${isStaggered ? 75 : 75} -25 L 25 25" stroke="${colorR}" stroke-width="5" fill="none" stroke-linecap="round" />
                        </svg>
                    `;

                    container.innerHTML = `
                        ${svg}
                        <div class="knot-circle" style="background-color: ${knotColor}" onclick="toggleKnot(${rowIndex}, ${kIdx})">
                            <svg class="knot-icon" viewBox="0 0 24 24">
                                <path d="${ICONS[type]}" fill="none" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    `;
                    rowDiv.appendChild(container);
                });

                gridEl.appendChild(rowDiv);
                stringState = [...nextState]; // Passa o resultado para a próxima linha
            });
        }

        function toggleKnot(r, k) {
            const current = rows[r].knots[k];
            const next = KNOT_TYPES[(KNOT_TYPES.indexOf(current) + 1) % 4];
            rows[r].knots[k] = next;
            renderApp();
        }

        init();
    </script>
</body>
</html>

