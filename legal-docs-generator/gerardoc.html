<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- Metadados e includes permanecem iguais -->
    <style>
        /* Adicionar ao CSS existente */
        .page-break {
            page-break-after: always;
            margin: 40px 0;
        }
    </style>
</head>
<body>
    <!-- Cabeçalho e estrutura HTML mantidos -->

    <script>
        $(document).ready(function() {
            // Máscaras mantidas

            // Gerar documento
            $('#generateBtn').click(async function() {
                if (!$('#petitionForm')[0].checkValidity()) {
                    $('#petitionForm')[0].reportValidity();
                    return;
                }

                // Carregar papel timbrado se existir
                const backgroundPdf = $('#backgroundPdf')[0].files[0];
                let background = '';
                if (backgroundPdf) {
                    background = await readFile(backgroundPdf);
                }

                await generateDocument(background);
                document.getElementById('preview-tab').click();
            });

            // Exportar PDF com papel timbrado
            $('#exportPdfBtn').click(async function() {
                const element = document.getElementById('documentPreview');
                const background = await getBackground();

                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: 'documento_juridico.pdf',
                    image: { type: 'jpeg', quality: 1 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: true
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: 'avoid-all' }
                };

                if (background) {
                    opt.background = background;
                }

                html2pdf().set(opt).from(element).save();
            });

            // Exportar DOCX melhorado
            $('#exportDocBtn').click(async function() {
                const content = document.getElementById('documentPreview').innerHTML;
                const cleanedContent = content.replace(/<br>/g, '</w:t><w:br/><w:t>')
                    .replace(/{|}/g, '');

                const doc = new docx.Document({
                    sections: [{
                        properties: {
                            page: {
                                size: {
                                    width: 11906, // A4 em twips (21cm)
                                    height: 16838  // 29.7cm
                                }
                            }
                        },
                        children: [
                            new docx.Paragraph({
                                children: [
                                    new docx.TextRun({
                                        text: cleanedContent.replace(/<[^>]+>/g, ''),
                                        break: 1
                                    })
                                ]
                            })
                        ]
                    }]
                });

                docx.Packer.toBlob(doc).then(blob => {
                    saveAs(blob, "documento_juridico.docx");
                });
            });
        });

        // Função para capitalizar texto
        function capitalizeText(text) {
            return text.toLowerCase()
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Gerar documento com formatação
        async function generateDocument(background) {
            try {
                const response = await fetch('../templates/inicial_trab.txt');
                let template = await response.text();
                
                const formData = new FormData(document.getElementById('petitionForm'));
                
                for (const [key, value] of formData.entries()) {
                    let processedValue = value;
                    
                    if (!key.startsWith('VALOR_') && key !== 'RECLAMANTE_SALARIO') {
                        processedValue = capitalizeText(value);
                    }

                    template = template.replace(new RegExp(`{{${key}}}`, 'g'), processedValue);
                }

                // Formatar data
                const date = new Date();
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                const city = document.getElementById('cidade_uf').value.split('/')[0];
                const formattedDate = `${city}, ${date.toLocaleDateString('pt-BR', options)}`;
                template = template.replace('{{CIDADE_DATA}}', formattedDate);

                // Remover chaves residuais
                template = template.replace(/{{\w+}}/g, '');

                document.getElementById('documentPreview').innerHTML = template
                    .replace(/\n/g, '<div class="page-break"></div>');

                if (background) {
                    document.getElementById('documentPreview').style.backgroundImage = `url(${background})`;
                }

            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao gerar documento!');
            }
        }

        // Utilitários para arquivos
        function readFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
            });
        }

        async function getBackground() {
            const file = $('#backgroundPdf')[0].files[0];
            return file ? await readFile(file) : null;
        }
    </script>
</body>
</html>
